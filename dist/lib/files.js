import*as o from"fs";import{fileURLToPath as a}from"url";import{dirname as n}from"path";import u from"fast-glob";import h from"../options/index.js";import p from"./apply-to.js";class g{paths=new Map;results=new Map;pipe;constructor(t=2){this.pipe={files:0,debug:t,info:{},current:{inputPath:"",outputPath:"",fileSizeAfter:0,fileSizeBefore:0}}}async in(t=!1){if(!t)return this;const e=p(p(t,i=>i instanceof URL?a(i):i),i=>i.endsWith("/")?i:`${i}/`);if(e instanceof Map)for(const[i,s]of e)this.paths.set(i,s);else this.paths.set(e,e);return this}async by(t=!1){if(!t)return this;for(const[e,i]of this.paths)for(const s of await u(t,{cwd:e,onlyFiles:!0}))this.results.set(`${i}${s}`,`${e}${s}`);return this}not(t){const e=new Set;if(typeof t<"u")if(t instanceof Array||t instanceof Set)for(const i of t)e.add(i);else e.add(t);for(const i of e){if(typeof i=="string")for(const s of this.results)(s[0].match(i)||s[1].match(i))&&this.results.delete(s[0]);if(typeof i=="function")for(const s of this.results)(i(s[0])||i(s[1]))&&this.results.delete(s[0])}return this}async apply(t=h.pipeline){for(const[e,i]of this.results)try{const s=(await o.promises.stat(i)).size;if(t.read&&t.wrote){const r=await t.wrote(i,await t.read(i));if(!r)return;if(t.passed&&await t.passed(s,r)){try{await o.promises.access(n(e),o.constants.W_OK)}catch{await o.promises.mkdir(n(e),{recursive:!0})}await o.promises.writeFile(e,r,"utf-8");const f=(await o.promises.stat(e)).size;this.pipe.debug>0&&(this.pipe.current={inputPath:i,outputPath:e,fileSizeBefore:s,fileSizeAfter:f},this.pipe.files++,t.changed&&(this.pipe=await t.changed(this.pipe))),this.pipe.debug>1&&typeof t.accomplished=="function"&&console.log(await t.accomplished(i,e,s,f))}}}catch{this.results.delete(e),typeof t.failed=="function"&&console.log(await t.failed(i))}return this.pipe.debug>0&&this.results.size>0&&typeof t.fulfilled=="function"&&console.log(await t.fulfilled(this.pipe)),this}}export{g as default};
