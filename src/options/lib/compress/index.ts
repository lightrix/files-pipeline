import { deepmerge } from "deepmerge-ts";

import formatBytes from "../../../lib/format-bytes.js";

import { callbacks as defaultCallbacks } from "../../index.js";
import type { optionCallbacksFile, optionCallbacksPipe } from "../../index.js";

import type CSS from "./css.js";
import type HTML from "./html.js";
import type IMG from "./img.js";
import type JS from "./js.js";
import type SVG from "./svg.js";

export const callbacks = deepmerge(defaultCallbacks, {
	failed: async (inputPath: optionCallbacksFile["inputPath"]) =>
		`Error: Cannot compress file ${inputPath} !`,
	passed: async (
		fileSizeBefore: optionCallbacksFile["fileSizeBefore"],
		writeBuffer:
			| string
			| NodeJS.ArrayBufferView
			| ArrayBuffer
			| SharedArrayBuffer
	) => fileSizeBefore > Buffer.byteLength(writeBuffer),
	accomplished: async (
		inputPath: optionCallbacksFile["inputPath"],
		outputPath: optionCallbacksFile["outputPath"],
		fileSizeBefore: optionCallbacksFile["fileSizeBefore"],
		fileSizeAfter: optionCallbacksFile["fileSizeAfter"]
	) =>
		`Compressed ${inputPath} for ${await formatBytes(
			fileSizeBefore - fileSizeAfter
		)} (${(
			((fileSizeBefore - fileSizeAfter) / fileSizeBefore) *
			100
		).toFixed(2)}% reduction) in ${outputPath}.`,
	fulfilled: async (pipe: optionCallbacksPipe) =>
		`Successfully compressed a total of ${pipe.files} ${pipe.type} ${
			pipe.files === 1 ? "file" : "files"
		} for ${await formatBytes(pipe.info.total)}.`,
	changed: async (pipe: optionCallbacksPipe) => {
		pipe.info.total =
			(pipe.info.total ? pipe.info.total : 0) +
			(pipe.current.fileSizeBefore - pipe.current.fileSizeAfter);
		return pipe;
	},
});

export interface Options {
	// rome-ignore lint:
	[key: string]: any;

	css?: boolean | CSS;

	html?: boolean | HTML;

	js?: boolean | JS;

	img?: boolean | IMG;

	svg?: boolean | SVG;
}

export default {
	css: {
		clone: false,
		comments: false,
		forceMediaMerge: true,
	},
	html: {
		caseSensitive: true,
		collapseInlineTagWhitespace: false,
		collapseWhitespace: true,
		continueOnParseError: true,
		html5: true,
		includeAutoGeneratedTags: true,
		keepClosingSlash: true,
		minifyCSS: true,
		minifyJS: true,
		minifyURLs: false,
		preventAttributesEscaping: false,
		processConditionalComments: false,
		removeAttributeQuotes: true,
		removeComments: true,
		ignoreCustomComments: [/^\s*#/, /^\s*!/, /^\s*\//],
		removeScriptTypeAttributes: true,
		removeStyleLinkTypeAttributes: true,
		removeTagWhitespace: false,
		sortAttributes: true,
		sortClassName: true,
		trimCustomFragments: true,
		useShortDoctype: false,
		noNewlinesBeforeTagClose: true,
		quoteCharacter: '"',
	},
	js: {
		ecma: 5,
		enclose: false,
		keep_classnames: false,
		keep_fnames: false,
		ie8: false,
		module: false,
		safari10: false,
		toplevel: false,
	},
	img: {
		avif: {
			chromaSubsampling: "4:4:4",
			effort: 9,
		},
		gif: {
			effort: 10,
		},
		jpeg: {
			chromaSubsampling: "4:4:4",
			mozjpeg: true,
			trellisQuantisation: true,
			overshootDeringing: true,
			optimiseScans: true,
		},
		png: {
			compressionLevel: 9,
			palette: true,
		},
		raw: {},
		tiff: {
			compression: "lzw",
		},
		webp: {
			effort: 6,
		},
	},
	svg: {
		multipass: true,
		js2svg: {
			indent: 0,
			pretty: false,
		},
		plugins: ["preset-default"],
	},
} satisfies Options;
